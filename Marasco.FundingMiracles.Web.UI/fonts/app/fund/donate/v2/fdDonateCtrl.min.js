"use strict";fundoloApp.controller("fdDonateCtrl",["$scope","$location","$stateParams","$uibModal","$log","$filter","seAuthSvc","fdSvc","userSvc","orDataSvc","mdCoreDataSvc",function(n,t,i,r,u,f,e,o,s,h,c){var a,v,w;o.basic(i.fundId).then(function(t){n.fund=angular.isArray(t)?t[0]:t;App.mallDub.setDomainColor(n.fund.pageColor,n.fund.pageSkin,n.fund.pageLayout);n.mainFundImage="/azure/"+n.fund.item.itemUploadList.upload.containerName+"/"+n.fund.item.itemUploadList.upload.name+"?height=150&width=230&mode=crop"},function(n){u.error(n)});c.getAllStates().then(function(t){n.states=t},function(n){toastr.error("Error getting states.  Please try again");u.error(n)});var l=function(){return angular.isUndefined(n.donation.amount)?0:n.donation.amount},y=function(){var t=l();n.level=t<100?0:t>=100&&t<200?1:2},p=function(t,i){var r=Math.round(t*i.levels[n.level].chargePercentage*2),u,f;r===0&&(r=.6);i.chargeFeeAmount=(r===0?0:r/2)+i.levels[n.level].chargeAmount;u=Math.round(t*i.levels[n.level].percentage*2);f=u===0?0:u/2;i.feeAmount=(i.levels[n.level].chargeFee?i.chargeFeeAmount:0)+f+i.levels[n.level].amount;i.beneficiaryAmount=t-(i.levels[n.level].chargeFee?i.chargeFeeAmount:0);i.iGotThisAmount=f+i.levels[n.level].amount+(i.levels[n.level].chargeFee?0:i.levels[n.level].chargeAmount)};n.items=function(){var t=[],i=l();return y(),angular.forEach(n.payOptions,function(r){p(i,r);var u=f("currency")(r.iGotThisAmount);r.name=r.levels[n.level].title.replace("{0}",r.levels[n.level].percentage===0?"":u+" ");t.push(r)}),t};n.donation={isPrivate:!1};n.isSaving=!1;n.step=1;n.isUpdating=!1;n.iGotThis=!0;n.iGotThisChecked=!1;n.coverFees="yes";n.yearOptions=c.yearOptions();n.monthOptions=c.monthOptions;n.selectedCardMonth=n.monthOptions[0].value;n.selectedCardYear=n.yearOptions[0].value;n.payOptions=c.payOptions;n.showValidationMessages=!1;n.dropdownItems=n.items();a="";v=!1;n.amountToCoverOptions=function(){var t=n.level,r=n.items(),u=l(),i=f("number")(u*c.defaultChargeFee*2,0),e=i===0?0:i/2;n.coverFees=this.coverFees;angular.forEach(r,function(i){var r;n.coverFees==="yes"?(i.levels[t].percentage=c.defaultChargeFee,i.levels[t].chargeFee=!1,r=f("currency")(i.levels[t].amount+e+i.levels[n.level].chargeAmount),i.name=i.levels[t].title.replace("{0}",i.levels[t].percentage===0?"":r+" "),n.iGotThis=!0):(i.levels[t].percentage=0,i.levels[t].chargePercentage=c.defaultChargeFee,i.levels[t].chargeFee=!0,i.name=i.levels[t].title.replace("{0}",""),n.iGotThis=!1)})};n.amountToCoverOptions();n.onFeeSelect=function(){n.selectedFee=this.selectedFee;n.isCustomAmount=this.selectedFee.levels[n.level].customizableAmount===!0?!0:!1};n.totalAmount=function(){var t=l();return y(),angular.isUndefined(n.selectedFee)&&(n.selectedFee=n.payOptions[2]),p(t,n.selectedFee),t+n.selectedFee.iGotThisAmount};n.makeAnonymous=function(){n.donation.isPrivate?(a=n.donation.donorName,n.donation.donorName="Anonymous",v=!0):(n.donation.donorName=a,a="",v=!1)};n.saveInfo=function(){n.isSaving=!0;this.fundDonationDonateForm.$valid?(n.customer={userName:n.donation.email,firstName:n.donation.donorName,lastName:n.donation.donorName,email:n.donation.email},s.getByUserName(n.donation.email).then(function(t){var i=angular.isArray(t)?t[0]:t;angular.isUndefined(i)?(toastr.error("There was a problem retrieving user information.  Please try again"),n.isSaving=!1):(n.customer.identification=i.identification,n.step=3,n.isSaving=!1,n.dropdownItems=n.items(),n.amountToCoverOptions())},function(t){t.status===404?e.registerAnonymous(n.customer).then(function(t){n.customer.identification=t.identification;n.step=3;n.isSaving=!1;n.dropdownItems=n.items();n.amountToCoverOptions()},function(t){toastr.error("There was a problem saving user info.  Please try again");u.error(t);n.isSaving=!1}):(toastr.error("There was a problem saving donation info. Please try again"),u.error(t),n.isSaving=!1)})):(n.isSaving=!1,n.showValidationMessages=!0)};n.savePayment=function(){n.isSaving=!0;this.fundDonationPaymentForm.$valid&&(w(),this.order.paymentMethodSystemName="Payments.WePay",this.order.billingAddressAddress.state=this.selectedState.identification,this.order.cardExpirationMonth=this.selectedCardMonth,this.order.cardExpirationYear=this.selectedCardYear,this.order.orderItemList=[{itemId:n.fund.identification,price:n.donation.amount}],this.order.statusId="Completed",this.order.PaymentStatusId="Paid",this.order.aspNetUser={email:n.donation.email,identification:n.customer.identification},this.order.customerId=n.customer.identification,this.order.donationList=[n.donation],h.save(this.order).then(function(){n.step=4;n.isSaving=!1},function(t){toastr.error(t.data.error_description);n.isSaving=!1}))};w=function(){n.donation.beneficiaryAmount=n.selectedFee.beneficiaryAmount;n.donation.systemAmount=n.iGotThis?n.selectedFee.feeAmount:n.selectedFee.levels[n.level].amount;n.donation.processingFee=n.selectedFee.feeAmount;n.donation.userId=n.customer.identification;n.donation.feeTypeId="Level0";n.donation.fundId=n.fund.identification;n.donation.offlineDonation=!1;n.donation.isPrivate=v;n.donation.statusId="Active";n.donation.thankYouNoteSent=!1};n.saveThankYou=function(){t.path("/"+n.fund.item.permalink)};n.updateAmount=function(){n.isUpdating=!1};n.editAmount=function(){n.isUpdating=!0};n.gotoStep=function(t){n.step=t;n.dropdownItems=n.items();n.amountToCoverOptions()};n.modalPaymentUsage=function(){var n=r.open({templateUrl:"/app/fund/donate/fdDonatePaymentUsageMdl.html",controller:paymentUsageModal,resolve:{items:function(){return"ok"}}});n.result.then(function(){},function(){})};n.resetAmount=function(){y();p(l(),n.selectedFee);n.amountToCoverOptions()};n.saveDonation=function(){n.isSaving=!0;this.fundDonationInfoForm.$valid?(n.showValidationMessages=!1,n.step=2):n.showValidationMessages=!0;n.isSaving=!1};n.open=function(){var t=r.open({templateUrl:"/app/fund/donate/fdDonateProcessingFeeMdl.html",controller:ModalInstanceCtrl,backdrop:"true",resolve:{items:function(){return n.items()},selectedFee:function(){return n.selectedFee},iGotThis:function(){return n.iGotThis},currentLevel:function(){return n.level},donationAmount:function(){return l()},amountToCover:function(){return c.defaultChargeFee},iGotThisChecked:function(){return n.iGotThisChecked}}});t.result.then(function(t){n.selectedFee=t;n.iGotThisChecked=t.levels[n.level].iGotThisChecked},function(){u.info("Modal dismissed at: "+new Date)})}}]);var ModalInstanceCtrl=["$scope","$uibModalInstance","$filter","items","selectedFee","iGotThis","iGotThisChecked",function(n,t,i,r,u,f,e,o,s,h){n.items=r;n.selectedFee=u;n.iGotThis=f;n.iGotThisChecked=e;n.amountToCoverF=i("number")(s*h*2,0);n.amountToCover=n.amountToCoverF===0?0:n.amountToCoverF/2;n.currentLevel=o;n.isCustomAmount=angular.isUndefined(u.isCustomAmount)?!1:u.isCustomAmount;n.amountToCoverOptions=function(t){var u=t.target;angular.forEach(r,function(t){var r;u.checked?(t.levels[o].percentage=h,t.levels[o].chargeFee=!1,r=i("currency")(t.levels[o].amount+n.amountToCover),t.name=t.levels[o].title.replace("{0}",t.levels[o].percentage===0?"":r+" ")):(t.levels[o].percentage=0,t.levels[o].chargePercentage=h,t.levels[o].chargeFee=!0,t.name=t.levels[o].title.replace("{0}"," "))})};n.ok=function(){this.selectedFee.levels[o].iGotThisChecked=this.iGotThisChecked;this.selectedFee.isCustomAmount=this.isCustomAmount;t.close(this.selectedFee)};n.cancel=function(){t.dismiss("cancel")};n.onFeeSelect=function(){n.isCustomAmount=this.selectedFee.levels[o].customizableAmount===!0?!0:!1}}],paymentUsageModal=["$scope","$uibModalInstance","items",function(n,t,i){n.items=i;n.ok=function(){t.close()};n.cancel=function(){t.dismiss("cancel")}}];
//# sourceMappingURL=fdDonateCtrl.min.js.map
